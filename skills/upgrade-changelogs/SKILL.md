---
name: upgrade-changelogs
description: "Download and trim changelogs and upgrade docs for all upgraded packages. Uses GitHub compare API with fallback, trims to relevant version range, cleans up empties."
disable-model-invocation: true
allowed-tools: Bash, Read, Glob, Grep, AskUserQuestion
---

# /upgrade-changelogs — Download & Trim Changelogs

Download CHANGELOG.md, UPGRADE.md, and related docs for every upgraded package, then trim
each file to the relevant version range (base -> target). The trimmed changelogs are used by
`/upgrade-build` to diagnose errors and by `/upgrade-analyze` to enrich TODOs.

Invoke after `/upgrade-composer` (needs `composer-diff.json` with resolved versions).

## Progress Tracking

Update `.ai-upgrade/progress.json`: set `"in-progress"` on entry with `startedAt`, `"completed"` on success with `completedAt` and summary in `notes`, `"failed"`/`"blocked"` on error.

## Prerequisites

- `.ai-upgrade/composer-diff.json` must exist (generated by `/upgrade-composer`)
- `gh` CLI authenticated with GitHub (for API calls)
- `jq` available

## Procedure

### Step 1 — Read config & check prerequisites

1. Read `.ai-upgrade/config.json` — extract `paths.aiUpgradeRoot`.
2. Verify `.ai-upgrade/composer-diff.json` exists. If missing -> stop, tell user to run `/upgrade-composer` first.
3. Verify `gh auth status` succeeds. If not -> stop, tell user to authenticate with `gh auth login`.
4. Verify `jq --version` succeeds.

### Step 1b — Git Preamble

Ensure workspace root is a git repo: `git rev-parse --git-dir 2>/dev/null`. If not -> `git init`, create `.gitignore` (`.ai-upgrade/*.sql.gz`, `application/*/vendor/`, `application/*/node_modules/`, `application/*/var/`, `*.sql`, `*.sql.gz`), initial commit.

### Step 2 — Generate the download list

Run the generate script from the workspace root:

```bash
bash skills/upgrade-changelogs/generate-changelog-list.sh
```

**Timeout: 600000ms** (many GitHub API calls).

This queries the GitHub compare API for each upgraded package, filters to relevant files
(CHANGELOG, UPGRADE, MIGRATION, BREAKING, CHANGES — including extensionless CHANGELOG),
and writes `.ai-upgrade/changelog-downloads.tsv`.

**Fallback mechanism**: when the compare API fails (no common ancestor), returns 300+ files
(truncation limit), or finds no relevant files, the script checks for well-known files
directly via the contents API at the target ref.

Report the summary to the user: total entries, errors, skipped.

### Step 3 — Download files

```bash
bash skills/upgrade-changelogs/download-changelogs.sh
```

**Timeout: 600000ms** (many downloads).

Downloads all files listed in the TSV into `changelogs/<package>/<filename>`. Use
`--skip-existing` to only download new entries when re-running.

Some download failures are expected (old UPGRADE-X.Y.md files that were deleted in newer
versions). Report the summary: downloaded, failed, skipped.

### Step 4 — Trim to relevant version range

```bash
bash skills/upgrade-changelogs/trim-changelogs.sh
```

Trims each file in-place to keep only versions above the base version from
`composer-diff.json`. Supports multiple formats:

- `## X.Y.Z` / `## [X.Y.Z]` headers (most common)
- `### X.Y.Z` headers (monolog, kreait)
- `# X.Y.Z (date)` headers (Twig)
- `X.Y` + `---` underline (Symfony components)
- `# Upgrade to X.Y` (Doctrine)
- `UPGRADE-X.Y.md` filename-versioned files

UNRELEASED sections are preserved — they contain upgrade-relevant content (e.g., Oro 7.0
changes that haven't been tagged yet).

Use `--dry-run` to preview without modifying files.

Report the summary: trimmed, emptied, kept as-is.

### Step 5 — Clean up

Delete empty files (emptied by trim) and empty directories:

```bash
find changelogs/ -type f -empty -delete
find changelogs/ -type d -empty -delete
```

### Step 6 — Validate & report

Report to the user:

1. **Total file count**: `find changelogs/ -type f | wc -l`
2. **Zero empty files**: `find changelogs/ -type f -empty` should return nothing
3. **Oro packages with CHANGELOG.md**: list all `changelogs/oro/*/CHANGELOG.md` — every
   oro/* package that was upgraded should have one (with content)
4. **Spot-check** a few key files:
   - `twig/twig/CHANGELOG` — should have 3.12+ content
   - A Symfony component — should start at 7.x
   - An Oro package — should have UNRELEASED section with 7.0 content

### Step 7 — Commit changelogs

Commit the changelogs directory and state files in the workspace root:

```bash
git add changelogs/ .ai-upgrade/changelog-downloads.tsv .ai-upgrade/changelog-errors.log .ai-upgrade/progress.json 2>/dev/null; \
  git diff --cached --quiet || git commit -m "upgrade-changelogs: download and trim changelogs for upgrade"
```

### Step 8 — Next step

- If patches detected (`config.json` -> `detection.hasPatchPlugin` is true) -> `/upgrade-patches`
- Otherwise -> `/upgrade-toolkit`
